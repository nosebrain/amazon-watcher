<?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="de.nosebrain.amazon.watcher.database.ItemMapper">

	<resultMap type="Item" id="itemResult">
		<result column="asin"			property="asin"			javaType="string" />
		<result column="name"			property="name"			javaType="string" />
		<result column="url"			property="url"			javaType="url" />
		<result column="limit"			property="limit"		javaType="Float" />
		<result column="date"			property="date"			javaType="date" />
		<result column="changeDate"		property="changeDate"	javaType="date" />
		<collection property="priceHistories" ofType="PriceHistory" column="asin" select="selectPriceHistoryForItem" />
	</resultMap>
	
	<resultMap type="PriceHistory" id="priceHistoryResult">
		<result column="price"		property="value"	javaType="float" />
		<result column="date"		property="date" 	javaType="date" />
	</resultMap>
	
	<select id="getAllWatchedItems" resultMap="itemResult">
		SELECT * FROM items i ORDER BY i.name
	</select>
	
	<select id="selectPriceHistoryForItem" resultMap="priceHistoryResult">
		SELECT * FROM history h WHERE h.asin = #{asin} ORDER BY h.date
	</select>
	
	<select id="getItemByASIN" parameterType="string" resultMap="itemResult">
		SELECT * FROM items i
			WHERE i.asin = #{asin}
	</select>
	
	<insert id="insertItem" parameterType="Item">
		INSERT INTO items (asin, name, url, mode, `limit`) VALUES (#{asin}, #{name}, #{url}, #{mode}, #{limit})
	</insert>
	
	<insert id="insertPrice" parameterType="priceParam">
		INSERT INTO history (asin, price) VALUES (#{asin}, #{price})
	</insert>
	
	<delete id="deleteItem" parameterType="string">
		DELETE FROM items
			WHERE asin = #{asin}
	</delete>
	
	<update id="updateItem" parameterType="Item">
		UPDATE items
			SET name = #{name},
				mode = #{mode},
				`limit` = #{limit},
				changeDate = CURRENT_TIMESTAMP
		WHERE asin = #{asin}
	</update>
</mapper>